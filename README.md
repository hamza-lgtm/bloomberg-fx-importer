# Bloomberg FX Deal Importer

This project is a Spring Boot microservice designed to accept and persist FX (Foreign Exchange) deal data for a data warehouse, as per the SDET challenge requirements.

The service provides a single API endpoint to import a batch of FX deals. It is designed for robustness, testability, and adherence to specific business logic:
1.  **Row-Level Validation:** Each deal is validated individually for missing fields and correct data types.
2.  **Deduplication:** The system prevents importing deals with the same `dealUniqueId` more than once.
3.  **"No Rollback" Semantics:** The service must process all deals in a request. If one deal fails (due to validation or a duplicate ID), it is logged as a failure, but all other valid deals in the same batch **must be saved** to the database.


## üõ†Ô∏è Tech Stack

* **Language:** Java 21
* **Framework:** Spring Boot 3
* **Build:** Maven
* **Database:** PostgreSQL
* **Containerization:** Docker & Docker Compose
* **Testing:**
    * **Unit:** JUnit 5, Mockito
    * **API/E2E:** RESTAssured
    * **Integration:** Testcontainers
    * **Coverage:** JaCoCo
    * **Performance:** K6

## üöÄ Requirements

* Java 21
* Maven 3.9
* Docker & Docker Compose
* K6 (For performance testing)
* Postman (For manual testing)

## üì¶ How to Run

The entire application stack (app + database) can be run using Docker Compose.

1.  **Build and Run with Makefile:**
    The simplest way is to use the provided `Makefile`.

    ```sh
    make up
    ```

2.  **Run Manually (without Makefile):**

    ```sh
    # 1. Build the app and run tests 
    .\mvnw clean install
    
    # 2. Start the application and database
    docker-compose up --build -d
    ```

* The API will be available at `http://localhost:8080`.
* The PostgreSQL database will be available at `localhost:5432`.

## üß™ Testing Strategy & Automation

This project is built with a 100% test coverage requirement, enforced by the JaCoCo build gate.

### Makefile Commands

A `Makefile` is provided to streamline all common tasks.

| Command | Description |
| :--- | :--- |
| `make build` | Runs `mvn clean install` to build, test, and check coverage. |
| `make up` | Builds the app and starts the Docker containers. |
| `make down` | Stops and removes all Docker containers and volumes. |
| `make test` | Runs only the unit and integration tests. |
| `make coverage` | Generates the JaCoCo HTML coverage report. |
| `make k6` | Runs the K6 performance tests against the running app. |
| `make logs` | Follows the application logs. |
| `make clean` | Cleans the Maven `target` directory. |

### JaCoCo Exclusions

The build enforces 100% test coverage. As required, trivial, generated, and non-logic classes are excluded from this check to ensure we only measure the core business logic.

A `lombok.config` file is also included to instruct JaCoCo to ignore all code generated by Lombok (builders, constructors, getters, etc.), which is a common cause of false negative coverage reports.

The following patterns are excluded in the `pom.xml`:

| File / Pattern | Justification for Exclusion |
| :--- | :--- |
| `FxDealImporterApplication.class` | Standard Spring Boot main class with no testable logic. |
| `com/bloomberg/fx/model/*.class` | JPA `@Entity` classes, which are data structures. |
| `com/bloomberg/fx/dto/*.class` | Data Transfer Objects (DTOs) used for API requests. |
| `com/bloomberg/fx/dto/*$*.class`| Nested DTO classes (like `ImportResultDTO$FailedDeal`). |
| `com/bloomberg/fx/exception/*.class` | Spring's `GlobalExceptionHandler` configuration. |

---

## üìñ API Documentation

The service provides a single endpoint for importing FX deals.

### Import FX Deals

Accepts a JSON array of FX deals and attempts to import each one individually, adhering to the "No Rollback" rule.

* **Endpoint:** `POST /api/v1/deals/import`
* **Status Code (on success):** `201 Created`
    * This status is returned even for partial success (e.g., 2 deals succeed, 1 fails). The response body contains the detailed breakdown.

#### Example `cURL` Request

This example sends a batch of 4 deals:
* `id-1001`: Valid (will be saved)
* `id-1002`: Valid (will be saved)
* `id-1003`: Invalid (bad currency code)
* `id-1001`: Duplicate (will be rejected)

```sh
curl -X POST 'http://localhost:8080/api/v1/deals/import' \
--header 'Content-Type: application/json' \
--data-raw '[
    {
        "dealUniqueId": "id-1001",
        "fromCurrency": "USD",
        "toCurrency": "EUR",
        "dealTimestamp": "2025-11-10T14:30:00Z",
        "dealAmount": 1500.75
    },
    {
        "dealUniqueId": "id-1Dosd-1002",
        "fromCurrency": "GBP",
        "toCurrency": "JPY",
        "dealTimestamp": "2025-11-10T14:31:00Z",
        "dealAmount": 250000
    },
    {
        "dealUniqueId": "id-1003",
        "fromCurrency": "AUD",
        "toCurrency": "US",
        "dealTimestamp": "2025-11-10T14:32:00Z",
        "dealAmount": 500.00
    },
    {
        "dealUniqueId": "id-1001",
        "fromCurrency": "USD",
        "toCurrency": "EUR",
        "dealTimestamp": "2025-11-10T14:30:00Z",
        "dealAmount": 1500.75
    }
]'
